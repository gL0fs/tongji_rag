# Tongji-RAG 智能问答系统接口文档 (v1.3)

> **版本**: 1.3 (完整版)
> **更新时间**: 2025-12-27  
> **协议**: HTTP/1.1  
> **数据格式**: JSON (Request/Response), SSE (Chat Stream)

## 基础信息
- **Base URL**: 
  - 开发环境: `http://124.221.26.181:8000`
- **鉴权方式**: 
  - 所有非公开接口均需在 Header 中携带: `Authorization: Bearer <Access_Token>`

---

## 1. 概述与变更说明
本版本核心变更为 **“会话类型隔离”** 及 **“完整生命周期管理”**。
系统划分为四个独立的业务模块，每个模块的会话（Session）和历史记录互不互通。

### 1.1 业务模块枚举 (`type`)
前端在调用 Session 相关接口和 Chat 接口时，必须严格区分以下 `type`：
| 模块类型 (`type`) | 描述 | 权限要求 |
| :--- | :--- | :--- |
| `public` | 公开问答 (校务公开/FAQ) | 所有用户 (含游客) |
| `academic` | 学术科研 (文献/知识库) | 学生、教师、访问学者 |
| `internal` | 内部行政 (通知/办事) | 学生、教师 |
| `personal` | 个人档案 (画像/推荐) | 学生、教师 |

### 1.2 鉴权方式
* **Header**: `Authorization: Bearer <access_token>`
---

## 2. 认证模块 (Auth)

### 2.1 用户登录
* **URL**: `/api/v1/login`
* **Method**: `POST`
* **Body**:
    ```json
    {
      "username": "2023001",
      "password": "password123"
    }
    ```
* **Response**:
    ```json
    {
      "access_token": "eyJhb...",
      "refresh_token": "def...",
      "token_type": "bearer",
      "expires_in": 1800,
      "user_info": { "name": "张三", "role": "student" }
    }
    ```

### 2.2 游客登录 (自动生成身份)
* **URL**: `/api/v1/guest-login`
* **Method**: `POST`
* **Body**: `{}` (空)
* **Response**: 包含临时 Token，用于后续 `public` 模块调用。

### 2.3 刷新 Token (Refresh)
用于 Access Token 过期后，使用 Refresh Token 获取新的令牌对。
* **URL**: `/api/v1/refresh`
* **Method**: `POST`
* **Body**:
    ```json
    {
      "refresh_token": "def..." // 登录时获取的长效 Token
    }
    ```
* **Response**:
    ```json
    {
      "access_token": "eyJhb...",
      "refresh_token": "new_def...", // 滚动更新，旧的失效
      "expires_in": 1800,
      "user_info": { "name": "张三" }
    }
    ```
* **Error**:
    * `401`: `Refresh token expired` (需重新登录)

### 2.4 退出登录 (Logout)
清除服务端（Redis）的 Refresh Token 记录。
* **URL**: `/api/v1/logout`
* **Method**: `POST`
* **Body**:
    ```json
    {
      "refresh_token": "def..."
    }
    ```
* **Response**:
    ```json
    {
      "message": "Logged out successfully"
    }
    ```

---

## 3. 会话管理模块 (Session)

### 3.1 创建新会话
**注意**：必须在 Body 中指定 `type`，后端会将该会话绑定到指定模块。

* **URL**: `/api/v1/session/new`
* **Method**: `POST`
* **Body**:
    ```json
    {
      "type": "academic"  // 必填: public | academic | internal | personal
    }
    ```
* **Response**:
    ```json
    {
      "session_id": "550e8400-e29b-...",
      "title": "新对话",
      "type": "academic",
      "created_at": "2025-06-09 10:00:00"
    }
    ```
* **Error**:
    * `400`: `Invalid session type` (类型参数错误)
    * `403`: `Permission denied` (例如游客尝试创建 internal 会话)

### 3.2 获取会话列表
**注意**：必须通过 Query 参数 `type` 筛选，前端应当根据当前选中的 Tab 传参。

* **URL**: `/api/v1/session/list?type={type}`
* **Method**: `GET`
* **Params**:
    * `type`: (必填) 模块类型，例如 `academic`
* **Response**:
    ```json
    {
      "data": [
        {
          "session_id": "550e8400-...",
          "title": "关于深度学习的论文",
          "type": "academic",
          "created_at": "2025-06-09 10:05:00"
        },
        {
          "session_id": "661f...",
          "title": "新对话",
          "type": "academic",
          "created_at": "2025-06-08 09:00:00"
        }
      ]
    }
    ```

### 3.3 获取单条会话历史详情
* **URL**: `/api/v1/session/{session_id}/history`
* **Method**: `GET`
* **Response**:
    ```json
    {
      "session_id": "550e8400-...",
      "messages": [
        {
          "role": "user",
          "content": "同济大学的校训是什么？",
          "timestamp": 1717900000
        },
        {
          "role": "assistant",
          "content": "同济大学的校训是：严谨、求实、团结、创新。",
          "timestamp": 1717900005
        }
      ]
    }
    ```

### 3.4 删除指定会话
永久删除某个会话及其历史记录。

* **URL**: `/api/v1/session/{session_id}`
* **Method**: `DELETE`
* **Response**:
    ```json
    {
      "message": "Session deleted successfully",
      "session_id": "550e8400-..."
    }
    ```
* **Error**:
    * `404`: `Session not found or permission denied` (会话不存在或不属于当前用户)
    * `401`: `User identity missing`

---

## 4. 对话/问答模块 (Chat)

### 4.1 发送消息 (流式响应)
**注意**：
1.  URL 路径包含 `type`。
2.  后端会强校验 Body 中的 `session_id` 是否属于 URL 中的 `type`，不匹配将报错。

* **URL**: `/api/v1/chat/{type}`
    * 例: `/api/v1/chat/academic`
    * 例: `/api/v1/chat/public`
* **Method**: `POST`
* **Content-Type**: `application/json`
* **Response-Type**: `text/event-stream` (SSE)
* **Body**:
    ```json
    {
      "query": "最近关于大模型的论文有哪些？",
      "session_id": "550e8400-...", // 必须是 academic 类型的 session_id
      "stream": true
    }
    ```

* **Stream Response (SSE 格式)**:
    ```text
    data: {"chunk": "根据"}
    
    data: {"chunk": "最新的"}
    
    data: {"chunk": "检索结果..."}
    
    data: [DONE]
    ```

* **Error Handling**:
    * 如果使用 `public` 的 `session_id` 请求 `/api/v1/chat/academic` 接口：
        * **Status**: `400 Bad Request`
        * **Detail**: `Session {id} does not belong to module 'academic'`

---

## 5. 通用错误码 (Error Codes)

系统遵循标准的 HTTP 状态码，常见错误如下：

| HTTP Code | Error Detail (示例) | 说明 |
| :--- | :--- | :--- | :--- |
| `400` | `Session ... does not belong to module ...` | 请求参数错误或逻辑校验失败 |
| `401` | `Token has expired` / `Invalid token` | 认证失败 |
| `403` | `Permission denied` / `Access Denied` | 权限不足 |
| `404` | `Pipeline not found` | 资源不存在 |
| `429` | `Guest rate limit exceeded` | 请求过于频繁 (仅限游客) |
| `500` | `Internal Server Error` | 服务端异常 |